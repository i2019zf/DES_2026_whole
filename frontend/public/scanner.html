<!DOCTYPE html>
<html>
<head>
    <title>DES Scanner | CONVERGENCE 2026</title>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
    <style>
        :root {
            --earth-green: #4ade80;
            --caution-yellow: #facc15;
            --error-red: #ff4d4d;
            --deep-stone: #1a1a1a;
            --already-blue: #3b82f6;
        }
        body { font-family: 'Inter', sans-serif; text-align: center; background: var(--caution-yellow); margin: 0; padding: 20px; }
        #preview { width: 100%; max-width: 400px; border: 5px solid var(--deep-stone); box-shadow: 10px 10px 0px var(--deep-stone); margin-bottom: 20px; }
        
        .result { 
            margin: 20px auto; 
            width: 90%; 
            max-width: 380px; 
            padding: 20px; 
            border: 5px solid var(--deep-stone); 
            display: none; 
            position: relative;
            overflow: hidden;
            background: white;
            box-shadow: 8px 8px 0px var(--deep-stone);
        }

        .success { background: var(--earth-green); }
        .fail { background: var(--error-red); color: white; }
        .duplicate { background: var(--already-blue); color: white; }

        .timer-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 10px;
            background: rgba(0,0,0,0.3);
            width: 100%;
        }

        .animate-timer {
            animation: shrink 4s linear forwards;
        }

        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
    </style>
</head>
<body>
    <h1 style="text-transform: uppercase;">DES Staff Scanner</h1>
    <p>CONVERGENCE 2026 | M. N. SAHA AUDITORIUM</p>
    
    <video id="preview"></video>
    
    <div id="status" class="result">
        <div id="content"></div>
        <div id="timerBar" class="timer-bar"></div>
    </div>

    <script>
        const video = document.getElementById('preview');
        const statusDiv = document.getElementById('status');
        const content = document.getElementById('content');
        const timerBar = document.getElementById('timerBar');
        let isProcessing = false;

        // --- UPDATE THIS URL ONLY ---
        const API_URL = 'https://6c1c44fbfae388.lhr.life/api/auth/verify-qr';

        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            requestAnimationFrame(tick);
        });

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && !isProcessing) {
                const canvas = document.createElement("canvas");
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    isProcessing = true;
                    verifyTicket(code.data);
                }
            }
            requestAnimationFrame(tick);
        }

        async function verifyTicket(qrData) {
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qrData }) // Backend expects 'qrData'
                });
                
                const data = await res.json();
                
                // Handle different backend status codes
                if (res.status === 200) {
                    showResult({ success: true, message: "VALID ENTRY", user: data.user, type: 'success' });
                } else if (res.status === 409) {
                    showResult({ success: false, message: "ALREADY SCANNED", user: data.user, type: 'duplicate' });
                } else {
                    showResult({ success: false, message: "INVALID TICKET", type: 'fail' });
                }
            } catch (err) {
                showResult({ success: false, message: "CONNECTION ERROR", type: 'fail' });
            }
        }

        function showResult(data) {
            statusDiv.style.display = 'block';
            statusDiv.className = `result ${data.type}`;
            content.innerHTML = `
                <h2 style="margin:0">${data.message}</h2>
                <p style="font-weight:bold; font-size:1.2rem">${data.user?.name || ''}</p>
            `;

            timerBar.classList.remove('animate-timer');
            void timerBar.offsetWidth; // Trigger reflow
            timerBar.classList.add('animate-timer');

            setTimeout(() => {
                statusDiv.style.display = 'none';
                isProcessing = false;
            }, 4000);
        }
    </script>
</body>
</html>